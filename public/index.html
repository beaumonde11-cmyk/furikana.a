<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ—¥æ–‡å…¨èƒ½åŠ©æ‰‹</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 30px auto; padding: 20px; background: #f0f2f5; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: #1a73e8; text-align: center; }
        textarea { width: 100%; height: 150px; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 18px; box-sizing: border-box; transition: border 0.3s; }
        textarea:focus { border-color: #1a73e8; outline: none; }
        .status-row { display: flex; justify-content: space-between; margin: 10px 0; min-height: 25px; }
        #warning { color: #d93025; font-weight: bold; visibility: hidden; }
        #char-count { color: #5f6368; }
        .btn-group { display: flex; gap: 10px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: opacity 0.2s; }
        #btn-furi { background: #1a73e8; }
        #btn-trans { background: #f9ab00; color: #202124; }
        #btn-speak { background: #34a853; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #bdc1c6 !important; cursor: not-allowed; }
        .display-area { margin-top: 25px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background: #fafafa; min-height: 100px; line-height: 2.2; font-size: 26px; }
        ruby rt { color: #d93025; font-size: 0.5em; }
    </style>
</head>
<body>
    <div class="card">
        <h1>ğŸ‡¯ğŸ‡µ æ—¥æ–‡å…¨èƒ½å­¦ä¹ åŠ©æ‰‹</h1>
        <textarea id="main-input" oninput="monitorText()" placeholder="è¯·è¾“å…¥æ—¥è¯­æ–‡ç« ..."></textarea>
        
        <div class="status-row">
            <div id="warning">âš ï¸ è¶…è¿‡500å­—ï¼Œå·²ç¦ç”¨æœ—è¯»åŠŸèƒ½</div>
            <div id="char-count">0 / 500</div>
        </div>

        <div class="btn-group">
            <button id="btn-furi" onclick="doFurigana()">æ±‰å­—æ³¨éŸ³</button>
            <button id="btn-trans" onclick="doTranslate()">ä¸­æ–‡ç¿»è¯‘</button>
            <button id="btn-speak" onclick="doSpeak()">å…¨æ–‡æœ—è¯»</button>
        </div>

        <div id="output" class="display-area">ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
    </div>

    <script>
        const input = document.getElementById('main-input');
        const countDisplay = document.getElementById('char-count');
        const warning = document.getElementById('warning');
        const speakBtn = document.getElementById('btn-speak');

        // æ ¸å¿ƒç›‘æ§é€»è¾‘
        function monitorText() {
            const len = input.value.length;
            countDisplay.innerText = `${len} / 500`;

            if (len > 500) {
                countDisplay.style.color = 'red';
                warning.style.visibility = 'visible';
                speakBtn.disabled = true;
            } else {
                countDisplay.style.color = '#5f6368';
                warning.style.visibility = 'hidden';
                speakBtn.disabled = false;
            }
        }

        async function doFurigana() {
            const res = await fetch('/furigana', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ text: input.value })
            });
            const data = await res.json();
            document.getElementById('output').innerHTML = data.html || "æ— å†…å®¹";
        }

        async function doTranslate() {
            const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=ja&tl=zh-CN&dt=t&q=${encodeURIComponent(input.value)}`;
            const res = await fetch(url);
            const data = await res.json();
            document.getElementById('output').innerText = data[0].map(x => x[0]).join('');
        }

        async function doSpeak() {
            if (!input.value) return;
            speakBtn.disabled = true;
            const audio = new Audio(`/speak?text=${encodeURIComponent(input.value)}&v=${Date.now()}`);
            audio.play().catch(e => alert("æ’­æ”¾å¤±è´¥ï¼Œè¯·é‡è¯•"));
            audio.onended = () => { if(input.value.length <= 500) speakBtn.disabled = false; };
        }
    </script>
</body>
</html>