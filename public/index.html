<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ—¥æ–‡å…¨èƒ½å­¦ä¹ åŠ©æ‰‹</title>
    <style>
        body { font-family: 'Microsoft YaHei', sans-serif; max-width: 800px; margin: 20px auto; background: #f9f9f9; padding: 20px; }
        .box { background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        textarea { width: 100%; height: 120px; border: 1px solid #ddd; padding: 10px; box-sizing: border-box; font-size: 16px; border-radius: 5px; margin-bottom: 5px; }
        
        .info-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; min-height: 25px; }
        #msg-tip { font-size: 13px; color: #d9534f; font-weight: bold; visibility: hidden; }
        .counter { font-size: 12px; color: #888; transition: all 0.3s; }
        
        .btns { display: flex; gap: 10px; margin-bottom: 20px; }
        button { flex: 1; padding: 12px; cursor: pointer; border: none; border-radius: 5px; color: #fff; font-weight: bold; transition: background 0.3s, opacity 0.3s; }
        #b1 { background: #007bff; } #b2 { background: #ffc107; color: #333; } #b3 { background: #28a745; }
        
        button:disabled { background: #ccc !important; cursor: not-allowed; opacity: 0.6; }
        
        .res { border: 1px dashed #007bff; padding: 15px; background: #f0f8ff; min-height: 50px; font-size: 24px; line-height: 2; margin-bottom: 15px; border-radius: 8px; }
        .trans { border: 1px dashed #ffc107; padding: 15px; background: #fffdf0; font-size: 16px; color: #444; border-radius: 8px; }
        ruby rt { color: #d9534f; font-size: 0.5em; }
    </style>
</head>
<body>
    <div class="box">
        <h1>ğŸ‡¯ğŸ‡µ æ—¥æ–‡å…¨èƒ½å­¦ä¹ åŠ©æ‰‹</h1>
        <textarea id="ipt" oninput="update()" placeholder="è¯·è¾“å…¥æ—¥æ–‡æ–‡æœ¬..."></textarea>
        
        <div class="info-bar">
            <div id="msg-tip">âš ï¸ å¯¹ä¸èµ·ï¼Œæ–‡æœ¬å·²è¶…500å­—ï¼Œæ— æ³•æœ—è¯»ã€‚</div>
            <div id="cnt" class="counter">0 / 500</div>
        </div>

        <div class="btns">
            <button id="b1" onclick="furi()">æ ‡æ³¨å‡å</button>
            <button id="b2" onclick="trans()">ç¿»è¯‘ä¸­æ–‡</button>
            <button id="b3" onclick="speak()">æœ—è¯»åŸæ–‡</button>
        </div>
        
        <div style="font-weight: bold; color: #666; margin-bottom: 8px;">æ³¨éŸ³ç»“æœï¼š</div>
        <div class="res" id="furi-res"></div>
        
        <div style="font-weight: bold; color: #666; margin-bottom: 8px;">ç¿»è¯‘ç»“æœï¼š</div>
        <div class="trans" id="trans-res">å°šæœªç¿»è¯‘...</div>
    </div>

    <script>
        // å…³é”®ï¼šå®æ—¶ç›‘æ§å¹¶è‡ªåŠ¨æ¢å¤
        function update() {
            const val = document.getElementById('ipt').value;
            const len = val.length;
            const cDisplay = document.getElementById('cnt');
            const tip = document.getElementById('msg-tip');
            const speakBtn = document.getElementById('b3');
            
            cDisplay.innerText = `${len} / 500`;

            if(len > 500) {
                cDisplay.style.color = 'red';
                cDisplay.style.fontWeight = 'bold';
                tip.style.visibility = 'visible';
                speakBtn.disabled = true;
            } else {
                cDisplay.style.color = '#888';
                cDisplay.style.fontWeight = 'normal';
                tip.style.visibility = 'hidden';
                speakBtn.disabled = false; // å½“å­—æ•°å‡å°æ—¶ï¼Œè‡ªåŠ¨æ¢å¤æŒ‰é”®
            }
        }

        async function furi() {
            const text = document.getElementById('ipt').value;
            if(!text) return;
            const r = await fetch('/furigana', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({text}) });
            const d = await r.json(); document.getElementById('furi-res').innerHTML = d.html;
        }

        async function trans() {
            const text = document.getElementById('ipt').value;
            if(!text) return;
            document.getElementById('trans-res').innerText = "æ­£åœ¨ç¿»è¯‘...";
            try {
                const r = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=ja&tl=zh-CN&dt=t&q=${encodeURIComponent(text)}`);
                const d = await r.json(); 
                document.getElementById('trans-res').innerText = d[0].map(x=>x[0]).join('');
            } catch(e) { document.getElementById('trans-res').innerText = "ç¿»è¯‘å¤±è´¥ã€‚"; }
        }

        async function speak() {
            const text = document.getElementById('ipt').value;
            if(!text || text.length > 500) return;

            const b = document.getElementById('b3');
            b.disabled = true;
            b.innerText = "åˆæˆéŸ³é¢‘ä¸­...";

            const audio = new Audio(`/speak?text=${encodeURIComponent(text)}&t=${Date.now()}`);
            
            try {
                await audio.play();
                b.innerText = "æ­£åœ¨æ’­æ”¾...";
            } catch(e) {
                alert("æ’­æ”¾è¢«æ‹¦æˆªï¼Œè¯·ç‚¹å‡»é¡µé¢åå†è¯•ã€‚");
                b.innerText = "æœ—è¯»åŸæ–‡";
                b.disabled = false;
            }

            audio.onended = () => {
                b.disabled = false;
                b.innerText = "æœ—è¯»åŸæ–‡";
            };
        }
    </script>
</body>
</html>